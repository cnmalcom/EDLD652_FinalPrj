---
title: "Textbooks"
author: "Cassie Malcom"
date: "2/17/2022"
output: 
  html_document:
        toc: true
        toc_float: true
        toc_depth: 4
        highlight: kate
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library-install, echo=FALSE}
library(pacman)
# install.packages(arrow)
```

```{r load-pkgs, echo=FALSE}
pacman::p_load(edld652, tidyverse, psych, rio, here, forcats, arrow, dplyr, stringr, readr, tidyr, corrplot, Hmisc, scales, RColorBrewer, ggmap, devtools, leaidr, piggyback, mapproj, maptools, gitcreds)
```

```{r calldata, echo=FALSE, eval=FALSE, results='hide'}
ethnic <- get_data("NCES_CCD_nonfiscal_school_2019_membership")

ethnic
```

```{r ethnic2, echo=FALSE, eval=FALSE, results='hide'}
e2 <- ethnic %>%
  filter(!is.na(STUDENT_COUNT))

e2
```

Filter to keep only those schools with 9th through 12th grade (High School)
```{r ethnic3, echo=FALSE, eval=FALSE, results='hide'}
e3 <- e2 %>%
  filter((GRADE=="Grade 9")|(GRADE=="Grade 10")|(GRADE=="Grade 11")|(GRADE=="Grade 12")|(str_detect(SCH_NAME, "High")))

e3
```

```{r checknames, echo=FALSE, eval=FALSE, results='hide'}
colnames(e3)
```

```{r ehtnic4, echo=FALSE, eval=FALSE, results='hide'}
e4 <- e3 %>%
  select(LEAID, GRADE, SCH_NAME, SCHOOL_YEAR, RACE_ETHNICITY, SEX, STUDENT_COUNT, ST)

e4
```

```{r ethnic5, echo=FALSE, eval=FALSE, results='hide'}
e5 <- e4 %>%
  group_by(LEAID, RACE_ETHNICITY) %>%
  summarise(student = sum(STUDENT_COUNT))

e5
```
Filter out the "no category codes" and "not specified", "two or more races"
```{r ethnic6, echo=FALSE, eval=FALSE, results='hide'}
e6 <- e5 %>%
  filter(RACE_ETHNICITY!="Not Specified" & RACE_ETHNICITY!="No Category Codes" & RACE_ETHNICITY!="Two or more races")

e6
```

```{r savec, echo=FALSE, eval=FALSE, results='hide'}
# write.csv(e6, "ethnicity.csv")
```

```{r calldata2, echo=FALSE, results='hide'}
ed <- read.csv("/Users/cassiemalcom/Desktop/CM2020/22_Winter Term Classes/EDLD 652_DS2/EDLD652_FinalPrj/Data/ethnicity.csv")

ed
```

```{r ethnicdata2, echo=FALSE, results='hide'}
ed2 <- ed %>%
  select(c(2,3,4))

ed2
```

Total is a new variable that shows the total number of student in 9th through 12th grade for each school district.
```{r ethnicdata3, echo=FALSE, results='hide'}
ed3 <- ed2 %>%
  group_by(LEAID) %>%
  mutate(total = sum(student))

ed3
```

Need to get all minorities into one sum. Pivot?
```{r ethnicdata3, echo=FALSE, results='hide'}
ed4 <- ed3 %>%
  pivot_wider(names_from = RACE_ETHNICITY, values_from = student)

ed4
```

How to get a table like this to scroll on knitting to HTML?
```{r minorities, echo=FALSE, results='hide'}
ed4$minority <- rowSums(ed4[ , c(3,4,5,6,7)], na.rm=TRUE)

ed4
```

The variable percentW is the percent of white students in a school district; while the variable percentM is the percent of minority students in a school district.
```{r percentages, echo=FALSE, results='hide'}
ed5 <- ed4 %>%
  mutate(percentW = round(White/total*100, digits = 2), percentM = round(minority/total*100, digits = 2))

ed5
```

```{r textbkdata, echo=FALSE, results='hide'}
tbd <- get_data("NCES_CCD_fiscal_district_2018")

tbd
```

V33 is the fiscal year 2019 fall membership; while V93 is textbook expenditures per school district. Also included the state name abbreviations (STABBR).
```{r tbd2, echo=FALSE, results='hide'}
tbd2 <- tbd %>%
  select(LEAID, V33, V93, STABBR)

tbd2
```

```{r tbd3, echo=FALSE, results='hide'}
 tbd3 <- tbd2 %>%
  filter(V93 >= 0)

tbd3
```

```{r tbd3convert, echo=FALSE, results='hide'}
tbd3$LEAID <- as.numeric(as.character(tbd3$LEAID))

tbd3
```

```{r tbd4join, echo=FALSE, results='hide'}
tbd4 <- left_join(ed5, tbd3, by = "LEAID")

tbd4
```

```{r sdchar, echo=FALSE, results='hide'}
x$LEAID <- as.numeric(as.character(x$LEAID))
```

```{r sdsort, echo=FALSE, results='hide'}
x2 <- x %>%
  select(LEAID,STUDENT_COUNT)

x2
```

Variable V33 (fall membership) matches the student_count variable so don't need to add the student count from the other data set.
```{r sdcheck, echo=FALSE, results='hide'}
tbd5 <- merge(tbd4, x2, by = "LEAID")

tbd5
```

```{r colcheck, echo=FALSE, results='hide'}
colnames(tbd4)
```


```{r Nout, echo=FALSE, results='hide'}
tbd6 <- tbd4 %>%
  filter(!is.na(V33))

tbd6
```

```{r Zout, echo=FALSE, results='hide'}
tbd7 <- tbd6 %>%
  filter(V93 > 0)

tbd7
```

```{r rnam, echo=FALSE, results='hide'}
  colnames(tbd7) [12] = "student_all"

tbd7
```

```{r rnam2, echo=FALSE, results='hide'}
  colnames(tbd7) [13] = "textbk_exp"

tbd7
```

```{r perS, echo=FALSE, results='hide'}
tbd_f <- tbd7 %>%
  mutate(textbk_exp_per_student = round(textbk_exp/student_all))

tbd_f

```

```{r rNeg, echo=FALSE, results='hide'}
tbd_f2 <- tbd_f %>%
   filter(textbk_exp >= 0)

tbd_f2

```

```{r rfil, echo=FALSE, results='hide'}
tbd_f3 <- tbd_f2 %>%
   filter(student_all >= 0)

tbd_f3
```

```{r rfil2, echo=FALSE, results='hide'}
tbd_f4 <- tbd_f3 %>%
  filter((White != 0)&(minority != 0))

tbd_f4
```


```{r p1, echo=FALSE}
p1 <- tbd_f4 %>%
  ggplot(aes(x = textbk_exp_per_student, y = percentM)) +
  geom_point(aes(color = textbk_exp_per_student), size=1) +
  scale_colour_gradient(low = "light green",
                       high = "blue", name = "Cost") +
  scale_x_continuous(labels = comma) +
       labs(title = "Relationship Between Percent Minority Students and Textbook Expenditure",
       y = "Percent of Minority Students in School District",
       x= "Amount of Textbook Expenditure per Student by School District") +
  theme(panel.background = element_rect(fill = "cornsilk", colour = "yellow"))

p1
```

Showing p1 should be sufficient as p2 doesn't offer any new information.
```{r p2, echo=FALSE}
p2 <- tbd_f4 %>%
  ggplot(aes(x = textbk_exp_per_student, y = percentW)) +
  geom_point(aes(color = textbk_exp_per_student), size=1) +
  scale_colour_gradient(low = "light green",
                       high = "blue", name = "Cost") +
  scale_x_continuous(labels = comma) +
       labs(title = "Relationship Between Percent White Students and Textbook Expenditure",
       y = "Percent of White Students in School District",
       x= "Amount of Textbook Expenditure per Student by School District") +
  theme(panel.background = element_rect(fill = "cornsilk", colour = "yellow"))

p2
```

```{r corr, echo=FALSE, results='hide'}
tbd_corr <- tbd_f4 %>%
  select(total, textbk_exp_per_student, percentM, percentW)

tbd_corr
```

Could not get these results to plot via corrplot. I don't see any significant correlation though so this might not be a RQ that we want to continue with.
```{r corr2, echo=FALSE, results='hide'}
mycorr <- rcorr(as.matrix(tbd_corr))

mycorr
```

```{r districtM, echo=FALSE, results='hide'}
# install.packages("devtools")
devtools::install_github("ivelasq/leaidr")
```

```{r gToken, echo=FALSE, results='hide'}
usethis::create_github_token()
```

```{r gCred, echo=FALSE, results='hide'}
gitcreds::gitcreds_set()
```

Over 1,200 schools in Oregon that are located in 197 school districts per https://www.oregon.gov/ode/schools-and-districts/Pages/default.aspx#:~:text=There%20are%20more%20than%201%2C200,in%20the%20State%20of%20Oregon.
```{r OR, echo=FALSE, results='hide'}
tbd_OR <- tbd_f4 %>%
  filter(STABBR=="OR")

tbd_OR
```

```{r OR2, echo=FALSE, results='hide'}
or <-
  lea_get("or")
```

```{r OR3, echo=FALSE, results='hide'}
or %>% 
  sf::st_as_sf() %>% 
  ggplot2::ggplot() +
  ggplot2::geom_sf()
```

```{r ORoverview, echo=FALSE, results='hide'}
str(or)
```

This code was just to check if GEOID, LEAID, and NCES ID variables are the same number, which they are. 
```{r findGEOID, echo=FALSE, results='hide'}
ca_data <-
  read_csv("https://raw.githubusercontent.com/making-data-science-count/covidedu/master/output/2020-04-29/summary-of-table-of-links.csv")

str(ca_data)
```

```{r ORmerge, echo=FALSE, results='hide'}
or_merge <-
  sp::merge(or, tbd_OR, by.x = "GEOID", by.y = "LEAID")

or_merge
```

```{r ORpoints, echo=FALSE, results='hide'}
# install.packages("gpclib")
gpclibPermit()
or_points <- fortify(or_merge, region = "GEOID")
```

```{r ORdf, echo=FALSE, results='hide'}
or_df <- left_join(or_merge@data, or_points, by = c("GEOID" = "id"))
```

Is there a way to roll over the map and have student population size for each school district pop up? Not thrilled with color yet either.
```{r ORmap, echo=FALSE}
or_map <-
  or_df %>% 
  ggplot() +
  geom_polygon(aes(x = long, 
                   y = lat, 
                   group = group,
                   fill = textbk_exp_per_student),
               color = "gray", 
               size = .2) +
  coord_fixed(1.3) +
  theme_void() +
  ggtitle("2018-2019 Textbook Expense* per Student by School District for Oregon") +
  labs(caption = "*In dollars", fill = "Textbook Expense") +
  theme(plot.title = element_text(hjust = -0.25))

or_map
```

This doesn't seem to generate any noticable changes from the above plot - DNU.
```{r ORmp, echo=FALSE, results='hide'}
map_projected <- or_map +
  coord_map()

print(map_projected)
```

